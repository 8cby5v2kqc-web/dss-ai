<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Rich Picture Editor — готовый JSON</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background: #2d2d2d;
        }
        .left-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
            border-right: 2px solid #555;
        }
        .right-panel {
            width: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #3c3c3c;
            padding: 10px;
        }
        .toolbar {
            padding: 10px;
            background: #e0e0e0;
            text-align: center;
            border-bottom: 1px solid #ccc;
        }
        button {
            background: #007acc;
            border: none;
            color: white;
            padding: 8px 16px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        button:hover { background: #005a9e; }
        canvas {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 100%;
            max-height: 100%;
        }
        .CodeMirror {
            height: 100% !important;
            font-size: 16px;
        }
        .error-message {
            color: #d32f2f;
            padding: 10px;
            background: #ffebee;
            margin: 10px;
            display: none;
            border-radius: 4px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
</head>
<body>
    <div class="left-panel">
        <textarea id="jsonCode" hidden></textarea>
        <div class="toolbar">
            <button onclick="render()">Обновить</button>
            <button onclick="format()">Форматировать</button>
        </div>
        <div id="error" class="error-message"></div>
    </div>
    <div class="right-panel">
        <canvas id="canvas" width="1200" height="800"></canvas>
    </div>

    <script>
        // --- Встроенный JSON (тот самый рабочий) ---
        const defaultJson = {
            rectangles: [
                { x: 50, y: 200, width: 180, height: 160, title: "Клиент", lines: ["тревога/депрессия", "сомнения, стигма", "ведёт дневник", "(бумага/телефон)"], color: "#bbdefb" },
                { x: 970, y: 200, width: 180, height: 160, title: "Психолог", lines: ["сессии, опросники", "(Beck, GAD-7)", "ручная обработка", "бумажные карты"], color: "#c8e6c9" },
                { x: 450, y: 220, width: 300, height: 220, title: "Защищенная платформа", lines: ["• Эл. опросники (автоподсчёт)", "• Безопасный дневник", "• Панель психолога", "• Шифрование и доступ"], color: "#ffe0b2" }
            ],
            clouds: [
                { x: 600, y: 60, width: 280, height: 70, lines: ["Нет структурированного", "наблюдения между сессиями"], color: "#ffe0b2" },
                { x: 1060, y: 100, width: 200, height: 60, lines: ["Ручная обработка →", "ошибки до 15%"], color: "#ffccbc" },
                { x: 140, y: 100, width: 200, height: 60, lines: ["Риск утечки", "конфиденциальных данных"], color: "#ffab91" }
            ],
            arrows: [
                { x1: 230, y1: 330, x2: 970, y2: 330, label: "Сессии", color: "#2c3e50", dashed: false },
                { x1: 230, y1: 280, x2: 450, y2: 300, label: "Заполняет скрининги,\nведёт дневник", color: "#2e7d32", dashed: false },
                { x1: 970, y1: 280, x2: 750, y2: 320, label: "Получает отчёты,\nотслеживает динамику", color: "#2e7d32", dashed: false }
            ]
        };

        // --- Настройка редактора ---
        const textarea = document.getElementById('jsonCode');
        const editor = CodeMirror.fromTextArea(textarea, {
            mode: { name: 'javascript', json: true },
            lineNumbers: true,
            indentUnit: 2,
            theme: 'default'
        });
        editor.setValue(JSON.stringify(defaultJson, null, 2));

        // --- Функции рисования (упрощённые, но рабочие) ---
        function drawRect(ctx, x, y, w, h, title, lines, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, w, h);
            ctx.font = 'bold 16px Times New Roman';
            ctx.fillStyle = '#000';
            ctx.textAlign = 'center';
            ctx.fillText(title, x + w/2, y + 25);
            ctx.font = '14px Times New Roman';
            for (let i = 0; i < lines.length; i++) {
                ctx.fillText(lines[i], x + w/2, y + 50 + i * 20);
            }
        }

        function drawCloud(ctx, x, y, w, h, lines, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.ellipse(x, y, w/2, h/2, 0, 0, 2*Math.PI);
            ctx.fill();
            ctx.strokeStyle = '#888';
            ctx.stroke();
            ctx.font = '14px Times New Roman';
            ctx.fillStyle = '#000';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            let startY = y - (lines.length-1)*8;
            for (let i = 0; i < lines.length; i++) {
                ctx.fillText(lines[i], x, startY + i*18);
            }
        }

        function drawArrow(ctx, x1, y1, x2, y2, label, color) {
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
            // наконечник
            let angle = Math.atan2(y2 - y1, x2 - x1);
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(x2, y2);
            ctx.lineTo(x2 - 10 * Math.cos(angle - 0.3), y2 - 10 * Math.sin(angle - 0.3));
            ctx.lineTo(x2 - 10 * Math.cos(angle + 0.3), y2 - 10 * Math.sin(angle + 0.3));
            ctx.closePath();
            ctx.fill();
            if (label) {
                ctx.font = 'italic 14px Times New Roman';
                ctx.fillStyle = '#333';
                ctx.textAlign = 'center';
                let midX = (x1 + x2)/2;
                let midY = (y1 + y2)/2 - 10;
                ctx.fillText(label, midX, midY);
            }
        }

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const errorDiv = document.getElementById('error');

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            errorDiv.style.display = 'none';
            try {
                const data = JSON.parse(editor.getValue());
                if (data.rectangles) data.rectangles.forEach(r => drawRect(ctx, r.x, r.y, r.width, r.height, r.title, r.lines, r.color));
                if (data.clouds) data.clouds.forEach(c => drawCloud(ctx, c.x, c.y, c.width, c.height, c.lines, c.color));
                if (data.arrows) data.arrows.forEach(a => drawArrow(ctx, a.x1, a.y1, a.x2, a.y2, a.label, a.color));
            } catch (e) {
                errorDiv.style.display = 'block';
                errorDiv.innerText = 'Ошибка в JSON: ' + e.message;
            }
        }

        function format() {
            try {
                const parsed = JSON.parse(editor.getValue());
                editor.setValue(JSON.stringify(parsed, null, 2));
            } catch (e) {
                alert('Невозможно отформатировать: ' + e.message);
            }
        }

        render(); // сразу рисуем
    </script>
</body>
</html>
