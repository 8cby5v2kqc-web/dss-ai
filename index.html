<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Rich Picture ‚Äî –∫—Ä–∞—Å–∏–≤–æ –∏ —É–¥–æ–±–Ω–æ</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background: #2d2d2d;
        }
        .left-panel {
            width: 40%;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
            border-right: 2px solid #555;
        }
        .right-panel {
            width: 60%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #3c3c3c;
            padding: 10px;
        }
        .toolbar {
            padding: 10px;
            background: #e0e0e0;
            text-align: center;
            border-bottom: 1px solid #ccc;
        }
        button {
            background: #007acc;
            border: none;
            color: white;
            padding: 8px 16px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        button:hover { background: #005a9e; }
        canvas {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 100%;
            max-height: 100%;
        }
        .CodeMirror {
            height: 100% !important;
            font-size: 16px;
        }
        .error-message {
            color: #d32f2f;
            padding: 10px;
            background: #ffebee;
            margin: 10px;
            display: none;
            border-radius: 4px;
        }
        .save-indicator {
            background: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.5s;
        }
    </style>
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <!-- Ajv –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/8.12.0/ajv.min.js"></script>
</head>
<body>
    <div class="left-panel">
        <textarea id="jsonCode" hidden></textarea>
        <div class="toolbar">
            <button onclick="render()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <button onclick="format()">–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button onclick="saveToStorage()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <span id="saveIndicator" class="save-indicator">‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
        </div>
        <div id="error" class="error-message"></div>
    </div>
    <div class="right-panel">
        <canvas id="canvas" width="1200" height="800"></canvas>
    </div>

    <script>
        // --- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π JSON (—É–∂–µ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π —Å—Ç—Ä–µ–ª–∫–æ–π) ---
        const defaultJson = {
            rectangles: [
                { x: 50, y: 200, width: 180, height: 160, title: "–ö–ª–∏–µ–Ω—Ç", lines: ["—Ç—Ä–µ–≤–æ–≥–∞/–¥–µ–ø—Ä–µ—Å—Å–∏—è", "—Å–æ–º–Ω–µ–Ω–∏—è, —Å—Ç–∏–≥–º–∞", "–≤–µ–¥—ë—Ç –¥–Ω–µ–≤–Ω–∏–∫", "(–±—É–º–∞–≥–∞/—Ç–µ–ª–µ—Ñ–æ–Ω)"], color: "#bbdefb" },
                { x: 970, y: 200, width: 180, height: 160, title: "–ü—Å–∏—Ö–æ–ª–æ–≥", lines: ["—Å–µ—Å—Å–∏–∏, –æ–ø—Ä–æ—Å–Ω–∏–∫–∏", "(Beck, GAD-7)", "—Ä—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞", "–±—É–º–∞–∂–Ω—ã–µ –∫–∞—Ä—Ç—ã"], color: "#c8e6c9" },
                { x: 450, y: 220, width: 300, height: 220, title: "–ó–∞—â–∏—â–µ–Ω–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞", lines: ["‚Ä¢ –≠–ª. –æ–ø—Ä–æ—Å–Ω–∏–∫–∏ (–∞–≤—Ç–æ–ø–æ–¥—Å—á—ë—Ç)", "‚Ä¢ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫", "‚Ä¢ –ü–∞–Ω–µ–ª—å –ø—Å–∏—Ö–æ–ª–æ–≥–∞", "‚Ä¢ –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ—Å—Ç—É–ø"], color: "#ffe0b2" }
            ],
            clouds: [
                { x: 600, y: 60, width: 280, height: 70, lines: ["–ù–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ", "–Ω–∞–±–ª—é–¥–µ–Ω–∏—è –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏"], color: "#ffe0b2" },
                { x: 1060, y: 100, width: 200, height: 60, lines: ["–†—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ ‚Üí", "–æ—à–∏–±–∫–∏ –¥–æ 15%"], color: "#ffccbc" },
                { x: 140, y: 100, width: 200, height: 60, lines: ["–†–∏—Å–∫ —É—Ç–µ—á–∫–∏", "–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"], color: "#ffab91" }
            ],
            arrows: [
                // –°—Ç—Ä–µ–ª–∫–∞ "–°–µ—Å—Å–∏–∏" —Ç–µ–ø–µ—Ä—å –Ω–∏–∂–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (y = 460)
                { x1: 230, y1: 460, x2: 970, y2: 460, label: "–°–µ—Å—Å–∏–∏", color: "#2c3e50", dashed: false },
                { x1: 230, y1: 280, x2: 450, y2: 300, label: "–ó–∞–ø–æ–ª–Ω—è–µ—Ç —Å–∫—Ä–∏–Ω–∏–Ω–≥–∏,\n–≤–µ–¥—ë—Ç –¥–Ω–µ–≤–Ω–∏–∫", color: "#2e7d32", dashed: false },
                { x1: 970, y1: 280, x2: 750, y2: 320, label: "–ü–æ–ª—É—á–∞–µ—Ç –æ—Ç—á—ë—Ç—ã,\n–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏–∫—É", color: "#2e7d32", dashed: false }
            ]
        };

        // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CodeMirror ---
        const textarea = document.getElementById('jsonCode');
        const editor = CodeMirror.fromTextArea(textarea, {
            mode: { name: 'javascript', json: true },
            lineNumbers: true,
            indentUnit: 2,
            theme: 'default',
            lineWrapping: true
        });
        editor.setValue(JSON.stringify(defaultJson, null, 2));

        // --- –í–∞–ª–∏–¥–∞—Ü–∏—è JSON-—Å—Ö–µ–º—ã (—á—Ç–æ–±—ã –Ω–µ –æ—à–∏–±–∏—Ç—å—Å—è) ---
        const schema = {
            type: "object",
            properties: {
                rectangles: {
                    type: "array",
                    items: {
                        type: "object",
                        properties: {
                            x: { type: "number" }, y: { type: "number" }, width: { type: "number" }, height: { type: "number" },
                            title: { type: "string" }, lines: { type: "array", items: { type: "string" } },
                            color: { type: "string", pattern: "^#[0-9A-Fa-f]{6}$" }
                        },
                        required: ["x", "y", "width", "height", "title", "lines"]
                    }
                },
                clouds: {
                    type: "array",
                    items: {
                        type: "object",
                        properties: {
                            x: { type: "number" }, y: { type: "number" }, width: { type: "number" }, height: { type: "number" },
                            lines: { type: "array", items: { type: "string" } },
                            color: { type: "string", pattern: "^#[0-9A-Fa-f]{6}$" }
                        },
                        required: ["x", "y", "width", "height", "lines"]
                    }
                },
                arrows: {
                    type: "array",
                    items: {
                        type: "object",
                        properties: {
                            x1: { type: "number" }, y1: { type: "number" }, x2: { type: "number" }, y2: { type: "number" },
                            label: { type: "string" }, color: { type: "string", pattern: "^#[0-9A-Fa-f]{6}$" }, dashed: { type: "boolean" }
                        },
                        required: ["x1", "y1", "x2", "y2"]
                    }
                }
            },
            additionalProperties: false
        };
        const ajv = new Ajv();
        const validate = ajv.compile(schema);

        // --- –§—É–Ω–∫—Ü–∏–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏—è (–∫—Ä–∞—Å–∏–≤—ã–µ) ---
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—É–≥–ª—ë–Ω–Ω–æ–≥–æ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞
        CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            this.moveTo(x + r, y);
            this.lineTo(x + w - r, y);
            this.quadraticCurveTo(x + w, y, x + w, y + r);
            this.lineTo(x + w, y + h - r);
            this.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
            this.lineTo(x + r, y + h);
            this.quadraticCurveTo(x, y + h, x, y + h - r);
            this.lineTo(x, y + r);
            this.quadraticCurveTo(x, y, x + r, y);
            return this;
        };

        function drawRectWithText(ctx, x, y, w, h, title, lines, color) {
            ctx.fillStyle = color;
            ctx.shadowColor = 'rgba(0,0,0,0.2)';
            ctx.shadowBlur = 8;
            ctx.shadowOffsetX = 3;
            ctx.shadowOffsetY = 3;
            ctx.beginPath();
            ctx.roundRect(x, y, w, h, 12);
            ctx.fill();
            ctx.shadowColor = 'transparent';
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.font = 'bold 18px "Times New Roman", serif';
            ctx.fillStyle = '#000';
            ctx.textAlign = 'center';
            ctx.fillText(title, x + w/2, y + 30);

            ctx.font = '16px "Times New Roman", serif';
            ctx.fillStyle = '#222';
            for (let i = 0; i < lines.length; i++) {
                ctx.fillText(lines[i], x + w/2, y + 60 + i * 24);
            }
        }

        function drawCloud(ctx, x, y, w, h, lines, color) {
            ctx.fillStyle = color;
            ctx.shadowColor = 'rgba(0,0,0,0.15)';
            ctx.shadowBlur = 8;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            ctx.beginPath();
            ctx.ellipse(x, y, w/2, h/2, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowColor = 'transparent';
            ctx.strokeStyle = '#888';
            ctx.lineWidth = 1.5;
            ctx.stroke();

            ctx.font = '16px "Times New Roman", serif';
            ctx.fillStyle = '#000';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            let startY = y - (lines.length-1) * 12;
            for (let i = 0; i < lines.length; i++) {
                ctx.fillText(lines[i], x, startY + i * 24);
            }
        }

        function drawArrow(ctx, x1, y1, x2, y2, label, color, dashed) {
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 2.5;
            ctx.setLineDash(dashed ? [8, 6] : []);
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
            ctx.setLineDash([]);

            // –ù–∞–∫–æ–Ω–µ—á–Ω–∏–∫
            const angle = Math.atan2(y2 - y1, x2 - x1);
            const arrowSize = 14;
            const dx = arrowSize * 0.7 * Math.cos(angle - 0.3);
            const dy = arrowSize * 0.7 * Math.sin(angle - 0.3);
            const dx2 = arrowSize * 0.7 * Math.cos(angle + 0.3);
            const dy2 = arrowSize * 0.7 * Math.sin(angle + 0.3);
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(x2, y2);
            ctx.lineTo(x2 - dx, y2 - dy);
            ctx.lineTo(x2 - dx2, y2 - dy2);
            ctx.closePath();
            ctx.fill();

            // –ü–æ–¥–ø–∏—Å—å (–º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–∞—è)
            if (label) {
                ctx.font = 'italic 16px "Times New Roman", serif';
                ctx.fillStyle = '#333';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                const midX = (x1 + x2) / 2;
                const midY = (y1 + y2) / 2 - 12;
                const lines = label.split('\n');
                for (let i = 0; i < lines.length; i++) {
                    ctx.fillText(lines[i], midX, midY + i * 22);
                }
            }
        }

        // --- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ ---
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const errorDiv = document.getElementById('error');
        const saveIndicator = document.getElementById('saveIndicator');

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.shadowColor = 'transparent';
            errorDiv.style.display = 'none';

            try {
                const data = JSON.parse(editor.getValue());
                const valid = validate(data);
                if (!valid) {
                    const errors = validate.errors.map(e => `${e.instancePath} ${e.message}`).join('; ');
                    throw new Error(`–°—Ö–µ–º–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞: ${errors}`);
                }

                if (data.rectangles) {
                    data.rectangles.forEach(r => drawRectWithText(ctx, r.x, r.y, r.width, r.height, r.title, r.lines, r.color));
                }
                if (data.clouds) {
                    data.clouds.forEach(c => drawCloud(ctx, c.x, c.y, c.width, c.height, c.lines, c.color));
                }
                if (data.arrows) {
                    data.arrows.forEach(a => drawArrow(ctx, a.x1, a.y1, a.x2, a.y2, a.label, a.color, a.dashed));
                }
            } catch (e) {
                errorDiv.style.display = 'block';
                errorDiv.innerText = '–û—à–∏–±–∫–∞: ' + e.message;
            }
        }

        // --- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ JSON ---
        function format() {
            try {
                const parsed = JSON.parse(editor.getValue());
                editor.setValue(JSON.stringify(parsed, null, 2));
            } catch (e) {
                alert('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å: ' + e.message);
            }
        }

        // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage ---
        const STORAGE_KEY = 'richPictureJson';

        function saveToStorage() {
            const jsonString = editor.getValue();
            try {
                JSON.parse(jsonString); // –ø—Ä–æ–≤–µ—Ä–∫–∞
                localStorage.setItem(STORAGE_KEY, jsonString);
                saveIndicator.style.opacity = '1';
                setTimeout(() => saveIndicator.style.opacity = '0', 2000);
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –≤ JSON, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ: ' + e.message);
            }
        }

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ JSON –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ---
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            try {
                JSON.parse(saved); // –ø—Ä–æ–≤–µ—Ä–∏–º
                editor.setValue(saved);
            } catch (e) {
                editor.setValue(JSON.stringify(defaultJson, null, 2));
            }
        } else {
            editor.setValue(JSON.stringify(defaultJson, null, 2));
        }

        // –ü–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
        render();
    </script>
</body>
</html>
